<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulateur DCA – Render</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --panel: #020617;
      --border: #1f2937;
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --text: #f9fafb;
      --muted: #9ca3af;
      --red: #dc2626;
      --green: #16a34a;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow:
        0 40px 90px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 24px 28px 24px;
      backdrop-filter: blur(16px);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
    }

    .title-block h1 {
      font-size: 1.6rem;
      margin: 0;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-pill {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .title-block p {
      margin: 6px 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .badge-live {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.7);
    }

    .controls {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.5fr) minmax(0, 1.6fr) auto;
      gap: 12px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
    }

    label {
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 8px 12px;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.3);
      background: rgba(15, 23, 42, 0.98);
    }

    .amount-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .amount-num {
      width: 86px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      flex: 1;
      background: transparent;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(55, 65, 81, 0.9);
      border-radius: 999px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: var(--accent);
      margin-top: -5px;
      box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.5);
    }

    .btn-run {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow:
        0 12px 30px rgba(129, 140, 248, 0.5),
        0 0 0 1px rgba(129, 140, 248, 0.4);
      white-space: nowrap;
    }

    .btn-run span.icon {
      font-size: 1.1rem;
    }

    .btn-run:active {
      transform: translateY(1px);
      box-shadow:
        0 6px 18px rgba(129, 140, 248, 0.3),
        0 0 0 1px rgba(129, 140, 248, 0.4);
    }

    .body-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 2.2fr);
      gap: 18px;
      margin-top: 20px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.92));
      border-radius: 18px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      padding: 14px 16px;
      position: relative;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.15), transparent 55%);
      opacity: 0.7;
      z-index: -1;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .metric {
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 12px;
    }

    .metric-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 1.15rem;
      font-weight: 500;
    }

    .metric-sub {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .gain-pos {
      color: var(--green);
    }

    .gain-neg {
      color: var(--red);
    }

    .chart-wrapper {
      height: 320px;
      position: relative;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 6px;
    }

    .chart-title {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .chart-sub {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .error-banner {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--red);
    }

    @media (max-width: 900px) {
      .controls {
        grid-template-columns: 1fr;
      }
      .body-grid {
        grid-template-columns: 1fr;
      }
      .chart-wrapper {
        height: 260px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title-block">
        <div class="title-pill">
          <span>Simulateur DCA</span>
          <span class="badge-live"><span class="badge-dot"></span> données marché</span>
        </div>
        <h1>Investissement mensuel automatisé</h1>
        <p>Choisis un titre, un montant mensuel et une date de départ. Le simulateur calcule le résultat de ton DCA.</p>
      </div>
    </div>

    <div class="controls">
      <!-- Symbole avec auto-complétion -->
      <div class="field">
        <label for="symbol-input">Action / ETF (auto-complétion)</label>
        <div style="position: relative;">
          <input
            id="symbol-input"
            type="text"
            placeholder="Tape ex : AAPL, MC.PA, TSLA..."
            autocomplete="off"
          />
          <div
            id="autocomplete-box"
            style="
              position: absolute;
              top: 40px;
              left: 0;
              right: 0;
              background: #020617;
              border: 1px solid #334155;
              border-radius: 12px;
              padding: 6px 0;
              display: none;
              z-index: 1000;
              max-height: 260px;
              overflow-y: auto;
            "
          ></div>
        </div>
      </div>

      <!-- Montant mensuel -->
      <div class="field">
        <label for="amount-range">Montant investi chaque mois (€)</label>
        <div class="amount-wrapper">
          <input
            id="amount-range"
            type="range"
            min="50"
            max="2000"
            step="50"
            value="100"
          />
          <input
            id="amount-number"
            type="number"
            class="amount-num"
            min="10"
            max="10000"
            step="10"
            value="100"
          />
        </div>
      </div>

      <!-- Date de début -->
      <div class="field">
        <label for="start-date">Date de départ</label>
        <input id="start-date" type="date" />
      </div>

      <!-- Bouton -->
      <div class="field">
        <button id="run-btn" class="btn-run">
          <span class="icon">▶</span>
          <span>Lancer la simulation</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-banner" style="display:none;"></div>

    <div class="body-grid" style="margin-top: 18px;">
      <!-- Metrics -->
      <div class="card">
        <div class="chart-header" style="margin-bottom: 6px;">
          <div>
            <div class="chart-title" id="summary-title">Aucun calcul pour l’instant</div>
            <div class="chart-sub" id="summary-sub">Configure ton DCA et lance une simulation.</div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Total investi</div>
            <div class="metric-value" id="metric-invested">–</div>
            <div class="metric-sub" id="metric-periods">–</div>
          </div>
          <div class="metric">
            <div class="metric-label">Valeur actuelle</div>
            <div class="metric-value" id="metric-value">–</div>
            <div class="metric-sub" id="metric-last-price">–</div>
          </div>
          <div class="metric">
            <div class="metric-label">Gain / Perte</div>
            <div class="metric-value" id="metric-gain">–</div>
            <div class="metric-sub" id="metric-gain-pct">–</div>
          </div>
          <div class="metric">
            <div class="metric-label">Paramètres</div>
            <div class="metric-sub" id="metric-params">Montant mensuel : 100 €</div>
            <div class="metric-sub" id="metric-dates">–</div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card">
        <div class="chart-header">
          <div class="chart-title" id="chart-title">Courbe DCA</div>
          <div class="chart-sub">Prix & valeur du portefeuille dans le temps</div>
        </div>
        <div class="chart-wrapper">
          <canvas id="dca-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let dcaChart = null;

    const inputSymbol = document.getElementById("symbol-input");
    const autoBox = document.getElementById("autocomplete-box");
    const startDate = document.getElementById("start-date");
    const amountRange = document.getElementById("amount-range");
    const amountNumber = document.getElementById("amount-number");
    const runBtn = document.getElementById("run-btn");
    const errorDiv = document.getElementById("error");

    const summaryTitle = document.getElementById("summary-title");
    const summarySub = document.getElementById("summary-sub");
    const metricInvested = document.getElementById("metric-invested");
    const metricValue = document.getElementById("metric-value");
    const metricGain = document.getElementById("metric-gain");
    const metricGainPct = document.getElementById("metric-gain-pct");
    const metricPeriods = document.getElementById("metric-periods");
    const metricParams = document.getElementById("metric-params");
    const metricDates = document.getElementById("metric-dates");
    const metricLastPrice = document.getElementById("metric-last-price");
    const chartTitle = document.getElementById("chart-title");

    // Date par défaut
    if (!startDate.value) {
      startDate.value = "2000-01-01";
    }

    // Sync montant
    amountRange.addEventListener("input", () => {
      amountNumber.value = amountRange.value;
      metricParams.textContent = `Montant mensuel : ${amountRange.value} €`;
    });

    amountNumber.addEventListener("input", () => {
      const v = Number(amountNumber.value || 0);
      amountRange.value = Math.min(Math.max(v, 10), 10000);
      metricParams.textContent = `Montant mensuel : ${amountNumber.value} €`;
    });

    function formatEuro(v) {
      if (v === null || v === undefined || isNaN(v)) return "–";
      return new Intl.NumberFormat("fr-FR", {
        style: "currency",
        currency: "EUR",
      }).format(v);
    }

    function formatPct(v) {
      if (v === null || v === undefined || isNaN(v)) return "–";
      return `${v.toFixed(2)} %`;
    }

    function showError(msg) {
      errorDiv.style.display = "block";
      errorDiv.textContent = msg;
    }

    function clearError() {
      errorDiv.style.display = "none";
      errorDiv.textContent = "";
    }

    // AUTOCOMPLETE
    let autoTimeout = null;

    inputSymbol.addEventListener("input", () => {
      const q = inputSymbol.value.trim();

      if (q.length < 2) {
        autoBox.style.display = "none";
        autoBox.innerHTML = "";
        return;
      }

      clearTimeout(autoTimeout);
      autoTimeout = setTimeout(() => {
        fetch(`/search?query=${encodeURIComponent(q)}`)
          .then((res) => res.json())
          .then((data) => {
            const symbols = data.symbols || [];

            if (symbols.length === 0) {
              autoBox.style.display = "none";
              autoBox.innerHTML = "";
              return;
            }

            autoBox.innerHTML = symbols
              .map(
                (item) => `
              <div class="auto-item"
                   data-symbol="${item.symbol}"
                   style="
                     padding: 8px 12px;
                     cursor: pointer;
                     border-bottom: 1px solid rgba(255,255,255,0.06);
                   ">
                <strong>${item.symbol}</strong> – ${item.name}
                <span style="color:#9ca3af">(${item.exchange})</span>
              </div>
            `
              )
              .join("");

            autoBox.style.display = "block";

            document.querySelectorAll(".auto-item").forEach((el) => {
              el.addEventListener("click", () => {
                const sym = el.dataset.symbol;
                inputSymbol.value = sym;
                autoBox.style.display = "none";
                autoBox.innerHTML = "";
              });
            });
          })
          .catch(() => {
            autoBox.style.display = "none";
            autoBox.innerHTML = "";
          });
      }, 200);
    });

    document.addEventListener("click", (e) => {
      if (!autoBox.contains(e.target) && e.target !== inputSymbol) {
        autoBox.style.display = "none";
      }
    });

    async function runSimulation() {
      clearError();

      const symbol = inputSymbol.value.trim().toUpperCase();
      const amount = Number(amountNumber.value || amountRange.value || 100);
      const start = startDate.value;

      if (!symbol) {
        showError("Merci de renseigner un symbole boursier.");
        return;
      }

      const params = new URLSearchParams({
        symbol: symbol,
        amount: String(amount),
      });
      if (start) params.append("start", start);

      let response;
      try {
        response = await fetch(`/dca?${params.toString()}`);
      } catch (e) {
        showError("Impossible d'atteindre l'API.");
        return;
      }

      let data;
      try {
        data = await response.json();
      } catch {
        showError("Format API invalide.");
        return;
      }

      if (!response.ok) {
        showError(data?.detail || "Erreur API.");
        return;
      }

      updateSummary(data, amount, symbol);
      updateChart(data);
    }

    function updateSummary(data, amount, symbol) {
      const last = data.data[data.data.length - 1];
      const isGain = data.total_gain >= 0 ? "gain-pos" : "gain-neg";

      summaryTitle.textContent = `DCA sur ${symbol}`;
      summarySub.textContent = `Investissement de ${formatEuro(amount)} par mois.`;

      metricInvested.textContent = formatEuro(data.total_invested);
      metricValue.textContent = formatEuro(data.current_value);

      metricGain.textContent = formatEuro(data.total_gain);
      metricGain.className = `metric-value ${isGain}`;

      const pct = data.total_gain_pct;
      metricGainPct.textContent = pct >= 0 ? `+${formatPct(pct)}` : formatPct(pct);
      metricGainPct.className = `metric-sub ${isGain}`;

      metricPeriods.textContent = `${data.n_periods} versements`;
      metricParams.textContent = `Montant mensuel : ${formatEuro(amount)}`;
      metricDates.textContent = `Période : ${data.start_date} → ${data.end_date}`;
      metricLastPrice.textContent = `Dernier cours : ${formatEuro(last.price)}`;

      chartTitle.textContent = `Courbe DCA – ${symbol}`;
    }

    function updateChart(data) {
      const labels = data.data.map((p) => p.date);
      const prices = data.data.map((p) => p.price);
      const values = data.data.map((p) => p.value);
      const isGain = data.total_gain >= 0;

      const ctx = document.getElementById("dca-chart").getContext("2d");

      if (dcaChart) dcaChart.destroy();

      dcaChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Prix de clôture",
              data: prices,
              yAxisID: "y",
              borderColor: "#9ca3af",
              backgroundColor: "rgba(156, 163, 175, 0.18)",
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 0,
            },
            {
              label: "Valeur du portefeuille",
              data: values,
              yAxisID: "y1",
              borderColor: isGain ? "#16a34a" : "#dc2626",
              backgroundColor: isGain
                ? "rgba(22,163,74,0.18)"
                : "rgba(220,38,38,0.18)",
              borderWidth: 3,
              tension: 0.3,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { labels: { font: { size: 11 } } },
            tooltip: {
              mode: "index",
              callbacks: {
                label: (ctx) =>
                  ctx.datasetIndex === 0
                    ? ` Prix : ${formatEuro(ctx.parsed.y)}`
                    : ` Valeur : ${formatEuro(ctx.parsed.y)}`,
              },
            },
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 10, font: { size: 10 } },
              grid: { display: false },
            },
            y: {
              position: "left",
              grid: { color: "rgba(31,41,55,0.6)" },
              ticks: { font: { size: 10 } },
            },
            y1: {
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: { font: { size: 10 } },
            },
          },
        },
      });
    }

    runBtn.addEventListener("click", runSimulation);
    window.addEventListener("load", () => {
      runSimulation();
    });
  </script>
</body>
</html>
